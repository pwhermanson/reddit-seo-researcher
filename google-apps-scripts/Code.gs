// ===============================================
// üìå How It Works - Google Apps Script
// ===============================================
// 1Ô∏è‚É£ User enters a target website into cell B1 in Google Sheets.
// 2Ô∏è‚É£ Script detects the change and prevents duplicate triggers for the same website.
// 3Ô∏è‚É£ Automatically grants "Editor" access to the Reddit scraper service account.
// 4Ô∏è‚É£ Prompts the user to confirm before starting the process.
// 5Ô∏è‚É£ If confirmed, the script sends a request to GitHub Actions to trigger `main.py`.
// 6Ô∏è‚É£ GitHub Actions runs the Reddit SEO Researcher script with the provided target website.
// 7Ô∏è‚É£ The script scrapes the website, analyzes the data with OpenAI, and updates Google Sheets.
// 8Ô∏è‚É£ The script logs GitHub response or errors for debugging.
// ===============================================


function customOnEdit(e) {
  if (!e || !e.range) {
    Logger.log("‚ö†Ô∏è Script manually executed. No edit detected.");
    return;
  }

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

  // ‚úÖ Ensure the edit was in B1 and only runs once per change
  if (e.range.getA1Notation() === "B1") {
    var targetWebsite = e.range.getValue();
    if (!targetWebsite) return;

    // ‚úÖ Prevent multiple triggers for the same site
    var scriptProperties = PropertiesService.getScriptProperties();
    var lastTriggered = scriptProperties.getProperty("LAST_TRIGGERED_SITE");

    if (lastTriggered === targetWebsite) {
      Logger.log("‚ö†Ô∏è Duplicate trigger prevented.");
      return;
    }

    scriptProperties.setProperty("LAST_TRIGGERED_SITE", targetWebsite);

    // ‚úÖ NEW: Automatically share the spreadsheet with the service account
    shareSpreadsheetWithServiceAccount();

    // ‚úÖ Show confirmation prompt only once
    var ui = SpreadsheetApp.getUi();
    var response = ui.alert("Confirm Operation", 
                            "Would you like to start the app for " + targetWebsite + "?", 
                            ui.ButtonSet.YES_NO);

    if (response == ui.Button.NO) {
      sheet.getRange("C1").setValue("‚ùå Operation canceled.");
      return;
    }

    triggerGitHubActions(targetWebsite);
  }
}



function triggerGitHubActions(targetWebsite) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  // ‚úÖ Retrieve GitHub Token from script properties
  var githubToken = PropertiesService.getScriptProperties().getProperty("GITHUB_TOKEN");
  
  // ‚úÖ Define GitHub repository details
  var repoOwner = "pwhermanson";  // üîπ REPLACE WITH YOUR GITHUB USERNAME
  var repoName = "reddit-seo-researcher";  // üîπ REPLACE WITH YOUR GITHUB REPOSITORY NAME
  var githubApiUrl = "https://api.github.com/repos/" + repoOwner + "/" + repoName + "/dispatches";

  var payload = {
    "event_type": "trigger_reddit_scraper", // ‚úÖ Matches GitHub Actions event trigger
    "client_payload": {
      "target_website": targetWebsite
    }
  };

  // ‚úÖ Log request details for debugging
  Logger.log("üöÄ Sending request to GitHub Actions...");
  Logger.log("üîπ Target Website: " + targetWebsite);
  Logger.log("üîπ API URL: " + githubApiUrl);
  
  var options = {
    "method": "POST",
    "headers": {
        "Accept": "application/vnd.github.v3+json",
        "Authorization": "Bearer " + githubToken
    },
    "payload": JSON.stringify(payload)
  };

  try {
    // ‚úÖ Send request to GitHub Actions
    var response = UrlFetchApp.fetch(githubApiUrl, options);
    var responseText = response.getContentText();
    
    // ‚úÖ Check for successful GitHub Actions trigger
    if (response.getResponseCode() === 204) {
      sheet.getRange("C1").setValue("‚úÖ Process Started for: " + targetWebsite);
      Logger.log("‚úÖ GitHub Actions triggered successfully.");
    } else {
      sheet.getRange("C1").setValue("‚ö†Ô∏è Unexpected Response from GitHub.");
      Logger.log("‚ö†Ô∏è GitHub Response: " + responseText);
    }
    
    // ‚úÖ Store GitHub API response in Google Sheets for debugging
    sheet.getRange("D1").setValue("GitHub Response:");
    sheet.getRange("E1").setValue(responseText);

  } catch (error) {
    // ‚ùå Handle API errors and log them in Google Sheets
    sheet.getRange("C1").setValue("‚ùå Error Triggering GitHub Actions");
    sheet.getRange("D2").setValue("Error Message:");
    sheet.getRange("E2").setValue(error.toString());
    Logger.log("‚ùå Error Triggering GitHub Actions: " + error.toString());
  }
}

function triggerKeywordInsightsAPI(targetWebsite) {
  // ‚úÖ Ensure KeywordInsights API runs after GitHub Actions completes
  Logger.log("üöÄ Sending cleaned questions to KeywordInsights API for clustering...");

  var keywordInsightsApiUrl = "https://api.keywordinsights.ai/cluster";
  var keywordInsightsPayload = {
    "event_type": "trigger_keyword_clustering",
    "client_payload": {
      "target_website": targetWebsite
    }
  };

  var keywordInsightsOptions = {
    "method": "POST",
    "headers": {
        "Accept": "application/json",
        "Authorization": "Bearer " + PropertiesService.getScriptProperties().getProperty("KEYWORDINSIGHTS_API_KEY")
    },
    "payload": JSON.stringify(keywordInsightsPayload)
  };

  try {
    var kiResponse = UrlFetchApp.fetch(keywordInsightsApiUrl, keywordInsightsOptions);
    var kiResponseText = kiResponse.getContentText();
    Logger.log("‚úÖ KeywordInsights API Response: " + kiResponseText);
  } catch (error) {
    Logger.log("‚ùå Error Triggering KeywordInsights API: " + error.toString());
  }
}
